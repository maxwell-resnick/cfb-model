name: game_picks

on:
  workflow_dispatch:
  schedule:
    # 08:15–22:15 ET (EDT=UTC-4) -> 12:15–02:15 UTC
    - cron: '15 12-23,0-2 * * *'

permissions:
  contents: read

concurrency:
  group: game_picks-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      DATABASE_URL:      ${{ secrets.DATABASE_URL }}
      GAME_PICK_WEBHOOK: ${{ secrets.GAME_PICK_WEBHOOK }}
      R_KEEP_PKG_SOURCE: no

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.1'
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache: true
          packages: |
            any::DBI
            any::RPostgres
            any::dplyr
            any::tidyr
            any::glue
            any::qs
            any::xgboost
            any::slider
            any::lubridate
            any::jsonlite
            any::httr
            any::glmmTMB
            any::TMB
            any::stringr
            any::purrr

      - name: Install oddsapiR (R-Universe)
        run: |
          Rscript -e 'install.packages("oddsapiR", repos=c("https://sportsdataverse.r-universe.dev","https://cloud.r-project.org"))'

      - name: Export DB env vars from DATABASE_URL
        run: |
          python - <<'PY' >> "$GITHUB_ENV"
          import os
          from urllib.parse import urlparse
          url = os.environ.get("DATABASE_URL", "")
          u = urlparse(url)
          print(f"PGHOST={u.hostname}")
          print(f"PGPORT={u.port or 5432}")
          print(f"PGDATABASE={u.path.lstrip('/')}")
          print(f"PGUSER={u.username}")
          print(f"PGPASSWORD={u.password}")
          print(f"NEON_PG_PASS={u.password}")
          PY

      - name: Run opening_line_preds.R
        env:
          GAME_PICK_WEBHOOK: ${{ env.GAME_PICK_WEBHOOK }}
        run: |
          set -o pipefail
          Rscript --vanilla opening_line_preds.R 2>&1 | tee r_run.log

      - name: Upload run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: r-run-log
          path: r_run.log
          retention-days: 7

      - name: Notify Discord on failure
        if: failure() && env.GAME_PICK_WEBHOOK != ''
        env:
          WEBHOOK: ${{ env.GAME_PICK_WEBHOOK }}
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          payload=$(cat <<'JSON'
          {"username":"OpeningLine Bot","embeds":[{"title":"❌ opening_line_preds failed","description":"Branch: **${{ github.ref_name }}**\nSee run logs for details.","url":"RUN_URL_PLACEHOLDER","timestamp":"NOW_PLACEHOLDER","color":15158332}]}
          JSON
          )
          payload=${payload//RUN_URL_PLACEHOLDER/"$RUN_URL"}
          payload=${payload//NOW_PLACEHOLDER/"$NOW"}
          curl -sS -H "Content-Type: application/json" -d "$payload" "$WEBHOOK"

